# Nox VoIP (LAN UDP)

LAN-based UDP VoIP application built with Qt 6 (C++17), with a lightweight control server and desktop client for real-time local network voice communication.

Lightweight LAN VoIP application built with Qt 6.

This repository currently ships a **minimal, deployable path**:
- UDP control server (`voip-server`)
- Qt Widgets desktop client (`voip-client`)

## 1. What This Project Does

The app allows clients on the same network to:
- discover/connect to a server
- join and leave sessions
- select talk targets (one or many users)
- exchange voice payloads over UDP
- view online users and connection quality state in UI

It is optimized for local/LAN testing and simple deployment.

## 2. High-Level Design

### Server (`voip-server`)
- Entry point: `server/main.cpp`
- Core service: `server/control_server.cpp`
- Receives UDP JSON control packets
- Maintains in-memory user/session state
- Responds to:
  - `ping` (health/latency checks)
  - `join`
  - `leave`
  - `talk`
  - `list`
  - `voice` forwarding

### Client (`voip-client`)
- Entry point: `client/main.cpp`
- UI: `client/MainWindow.cpp`, `client/MainWindow.ui`
- Network client: `client/control_client.cpp`
- Audio: `client/AudioEngine.cpp`
- Protocol encoding helpers: `shared/protocol/control_protocol.h`

The client includes stabilized network quality logic:
- no immediate `Bad` on a single timeout
- rolling ping history
- hysteresis to prevent fast `Good/Average/Bad` flips

## 3. Current Build Scope (Important)

`CMakeLists.txt` builds only:
- `voip-server`
- `voip-client`

Many extra files exist in `client/`, `server/`, and `shared/` from broader/legacy Mumble-style code paths.  
Those files are **not** currently part of deploy scope unless explicitly added back to CMake.

## 4. Repository Structure

```text
Nox/
  CMakeLists.txt
  constants.h
  README.md
  .gitignore

  client/
    main.cpp
    MainWindow.h
    MainWindow.cpp
    MainWindow.ui
    AudioEngine.h
    AudioEngine.cpp
    control_client.h
    control_client.cpp
    ... (additional non-target files present)

  server/
    main.cpp
    control_server.h
    control_server.cpp
    ... (additional non-target files present)

  shared/
    protocol/
      control_protocol.h
    ... (additional non-target files present)

  thirdparty/
    opus/
    speexdsp/

  build-mingw/      (generated by CMake; ignored in git)
```

## 5. Tech Stack

- C++17
- Qt 6 modules:
  - `Core`
  - `Gui`
  - `Widgets`
  - `Network`
  - `Multimedia`
- CMake (AUTOMOC/AUTOUIC/AUTORCC enabled)
- MinGW toolchain on Windows (current setup)

## 6. Prerequisites

- Qt 6 installed (matching MinGW kit)
- CMake >= 3.21
- MinGW compiler toolchain available in PATH

If CMake cannot find Qt automatically, set `Qt6_DIR` (example in `CMakeLists.txt` comments).

## 7. Build Instructions

### Configure
```bash
cmake -S . -B build-mingw
```

### Build
```bash
cmake --build build-mingw -- -j4
```

### Clean + Rebuild
```bash
cmake --build build-mingw --target clean
cmake --build build-mingw -- -j4
```

## 8. Run Instructions (Windows)

### Start server
```powershell
.\build-mingw\voip-server.exe 45454
```

### Start client
```powershell
.\build-mingw\voip-client.exe 127.0.0.1
```

You can pass a LAN IP instead of `127.0.0.1` when running across machines.

## 9. Message/Flow Summary

Control packets are encoded/decoded through `shared/protocol/control_protocol.h`.

Typical flow:
1. Client `ping` -> server `pong`
2. Client `join`
3. Client `list` requests and receives users
4. Client `talk` updates speaking targets
5. Client sends `voice` payloads
6. Server forwards `voice` to relevant targets
7. Client `leave`

## 10. Deployment Notes

Current deployment target:
- `build-mingw/voip-server.exe`
- `build-mingw/voip-client.exe`

Runtime dependencies (Qt + MinGW DLLs) must be present beside binaries (or deployed via `windeployqt`).

## 11. Troubleshooting

### CMake cannot find Qt
- Set `Qt6_DIR` to your Qt kitâ€™s `lib/cmake/Qt6`.

### Server unreachable from client
- Verify IP/port (default port in `constants.h`)
- Allow app/port through Windows firewall
- Test with `127.0.0.1` first on same machine

### Network status fluctuates
- UI status includes app scheduling/processing, not only raw wire RTT
- Current logic already uses smoothing + hysteresis for stability

### No audio
- Check mic/speaker device permissions
- Ensure capture/playback devices are available in OS

## 12. Known Limitations

- The repository includes extra source trees not wired into current CMake targets.
- Full Mumble-compatible stack is intentionally not enabled in current deployable mode.

## 13. License / Third-Party

- Third-party source/code artifacts are under `thirdparty/`.
- Review `thirdparty/speexdsp/COPYING` and other vendor files before redistribution.

## 14. Suggested Workflows

### Workflow A: Daily Development (Recommended)
1. Pull latest changes.
2. Configure once:
```bash
cmake -S . -B build-mingw
```
3. Build incrementally:
```bash
cmake --build build-mingw -- -j4
```
4. Run server + client locally:
```powershell
.\build-mingw\voip-server.exe 45454
.\build-mingw\voip-client.exe 127.0.0.1
```
5. Test:
- join/leave
- user list refresh
- talk target selection
- voice send/receive
- network quality label behavior

### Workflow B: Feature Branch + PR
1. Create branch:
```bash
git checkout -b feature/<name>
```
2. Implement small vertical changes (UI + control + protocol if needed).
3. Build after each logical step.
4. Commit with scoped messages:
```bash
git commit -m "client: improve network quality hysteresis"
```
5. Push branch and open PR.

### Workflow C: Audio/Networking Debug Session
Use this when call quality or status behavior looks wrong.
1. Run server on localhost first (`127.0.0.1`) to remove LAN noise.
2. Re-test with LAN IP on second machine.
3. Validate ping stability in UI.
4. In debug builds, inspect `qDebug()` logs from control/audio paths.
5. Compare behavior with firewall on/off (or allow-list app/port).

### Workflow D: Release Build and Packaging
1. Clean rebuild:
```bash
cmake --build build-mingw --target clean
cmake --build build-mingw -- -j4
```
2. Confirm generated binaries:
- `build-mingw/voip-server.exe`
- `build-mingw/voip-client.exe`
3. Deploy runtime dependencies:
- Qt DLLs
- MinGW runtime DLLs
- Qt plugin folders as needed (`platforms`, `multimedia`, etc.)
4. Smoke test on a clean machine/profile.

### Workflow E: CI-Friendly Command Set
For automation scripts:
```bash
cmake -S . -B build-mingw
cmake --build build-mingw -- -j4
```
Optional runtime smoke check:
```powershell
.\build-mingw\voip-server.exe 45454
```
